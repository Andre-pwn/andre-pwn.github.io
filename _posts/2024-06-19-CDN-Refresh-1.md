---
title: Refresh CDN Cache
author: Leesh
categories: [CDN, Cache Refresh]
tags: [CDN, 컨텐츠 전송 네트워크, 미디어/웹 캐시, WAAP, Cloud]
date: '2024-06-20 09:35:00 +0900'
---
## Refresh CDN Cache

---

CDN은 전 세계 여러 거점(POP)에 분산된 서버로, **캐시된 콘텐츠**를 사용자에게 빠르게 전달하는 역할을 합니다.<br>
원본 서버의 콘텐츠가 업데이트될 때마다 CDN 서버들이 최신 콘텐츠를 제공할 수 있도록 **캐시를 갱신**하는 것이 필요합니다.<br>
Cache Refresh는 CDN 서버에 캐시된 콘텐츠를 삭제(Purge)하거나 업데이트(캐시 유효성 검증)하여 사용자에게 최신 정보를 제공하는 과정을 의미합니다.

## Cache refresh는 어떤 상황에 사용할까?

---

* **콘텐츠 업데이트**:<br>
  웹사이트의 원본 콘텐츠(텍스트, 이미지, 스크립트, 동영상 등)를 수정했을 때, 사용자에게 변경된 최신 콘텐츠를 제공하기 위해 캐시를 갱신해야 합니다.


* **콘텐츠의 버그/보안 이슈**:<br>
  사용자에게 제공 중인 콘텐츠에 오류나 보안 문제를 발견한 경우,<br>
  원본 서버에서 해당 콘텐츠를 수정하거나 삭제한 후, 기존의 캐시된 오류 또는 보안 문제가 있는 콘텐츠를 더 이상 서비스되지 않도록 삭제(Purge)해야 할 경우 사용합니다.

## Cache refresh 유형

---
**수동 캐시 리프레시**:
* 관리자가 즉각적으로 **Cache Purge 요청**을 수행할 수 있어 신속한 캐시 리프레시가 필요할 경우 사용합니다.
* CDN 서비스 관리 콘솔이나 Cache Purge API를 통해 수행할 수 있습니다.

**자동 캐시 리프레시**:
* CDN 설정에서 **일정한 시간 간격(Cache TTL)**마다 자동으로 캐시를 새로 갱신하여 관리가 용이하지만, 콘텐츠가 자주 변경되는 경우 실시간성이 떨어집니다.
* "Cache-Control: max-age=xxxxx" 캐시 컨트롤 헤더를 통해 TTL을 제어할 수 있습니다.
* Cache TTL이 만료되면, 사용자 IMS(If-Modified-Since) 요청에 따라 캐시 유효성(Cache refresh 여부)을 원본 서버와 검증합니다.
  > 원본 서버에서 해당 요청이 유효하다면(변경이 없다면) 304 Not Modified 응답으로 캐시된 기존 콘텐츠로 서비스됩니다.\
  > 원본 서버의 콘텐츠가 더 최신이라면 200(또는 206) 응답으로 최신 콘텐츠를 전송하고 캐시도 갱신됩니다.

**프리페칭(Pre-fetching)**:
* 캐시되지 않은 신규 콘텐츠를 CDN 서버에 **사전 캐시**하여 CDN 엣지에서 즉각 서비스하는 것을 말합니다.

  > CDN에 캐시를 하기 위해서는 원본 서버에서 파일을 가져와 캐시하는 데 시간이 소요됩니다.\
  > 이를 프리페칭 기능을 사용하여, `CDN 엣지에 핫 콘텐츠를 미리 캐시해두고 서비스함으로써 사용자 전송 속도를 향상시키고, 원본 서버의 부담을 완화`할 수 있습니다.\
  > CDN 사업자에 따라, 별도 과금이 필요한 기능일 수 있습니다.
  
## 편법적인 캐시 refresh

---
### URL에 쿼리스트링 포함하여 호출

CDN 및 웹 브라우저 캐시는 URL을 기반으로 콘텐츠를 저장합니다.<br>
동일한 URL로 요청이 들어오면, 캐시된 콘텐츠를 응답하지만, URL이 다르면 새로운 요청으로 인식하여 원본 서버에서 콘텐츠를 가져옵니다.<br>
이를 이용해 URL에 `값이 변경되는 쿼리스트링을 추가하면, 다른 URL로 요청을 보내는 것과 같은 효과`를 가져 캐시를 우회하여 최신 콘텐츠를 가져올 수 있습니다.

**일반적인 URL:**
```
https://example.com/image.jpg
```

**쿼리스트링 포함 URL:**
```
https://example.com/image.jpg?v=20240619
```

여기서 `v=20240619` 쿼리스트링으로 인해, 사실상 동일한 image.jpg 이지만, 캐시된 콘텐츠가 아닌 원본 서버로 새로운 콘텐츠 요청을 하게 되어 최신 콘텐츠를 가져오게 됩니다.

### 주의점
URL에 쿼리스트링을 포함하여 캐시를 우회하는 방법은,<br>
별도의 캐시 정책 없이 캐시된 콘텐츠를 간편하게 refresh할 수 있는 방법으로, 웹 개발자가 쉽게 구현할 수 있습니다.<br>
그러나 `잘못된 코딩으로 무분별한 랜덤값 쿼리스트링`을 사용하면, CDN 캐시에 적중하지 못하고 원본 서버로 계속 요청이 발생하여 `속도(성능) 저하와 리소스 낭비`를 초래할 수 있으므로 주의가 필요합니다.
