---
title: Linux - DNS
date: 2020-07-16 11:11:11 -0400
categories: [00Basic, Network]
tags: [Linux, Setup, DNS, Sysadmin]
math: true
image:
---

- [DNS](#dns)
  - [basic](#basic)
  - [Amazon Route 53](#amazon-route-53)
    - [ROUTING POLICIES](#routing-policies)
    - [CHARGES](#charges)
  - [DNS over HTTPS](#dns-over-https)

---


# DNS

---


## basic




---

## Amazon Route 53

- a Tier 0 service
  - it is designed and maintained with the highest level of availability in mind.


- a highly available and scalable **cloud Domain Name System (DNS) web service**.
  - Route 53 is where to configure and manage web domain for website /application that host on AWS
  - Services that has 100% uptime availability SLA
  - Primarily uses UDP 53 (can use TCP). The DNS servers respond to queries on port UDP 53
  - provides a worldwide distributed DNS service.
  - Route 53 is located alongside all edge locations.
  - Can extend an on-premises DNS to VPC.
  - cannot extend Route 53 to on-premises instances.

- avaliable and cost-effective way to route users to internet applications
  - translating names into the IP addresses that computers use to connect to each other.

- Feature: Route 53 can perform any combination of these functions

  - offers Domain Name Registration
    - purchase and manage domain names (like example.com)
    - use the AWS Management Console or API to register new domain names.
    - default limit of 50 domain names but can be increased by contacting support.
    - When you register a domain with Route 53
      - Route 53 will automatically configure DNS settings for your domains.
      - it becomes the authoritative DNS server for that domain
      - creates a public hosted zone.
      - cannot automatically register EC2 instances with private hosted zones (would need to be scripted).

  - authoritative DNS
    - To make Route 53 the authoritative DNS for an existing domain without transferring the domain
    - create a Route 53 public hosted zone and change the DNS Name Servers on the existing provider to the Route 53 Name Servers.
    - Changes to Name Servers may not take effect for up to 48 hours due to the DNS record Time To Live (TTL) values.

  - transfer domains
    - can transfer domains to Route 53 only if the Top Level Domain (TLD) is supported.
    - can transfer a domain from Route 53 to another registrar by contacting AWS support.
    - can transfer a domain to another account in AWS however it does not migrate the hosted zone by default (optional).
    - It is possible to have the domain registered in one AWS account and the hosted zone in another AWS account.

  - DNS resolution.
    - can be used to route Internet traffic for domains that registered by another domain registrar (any domain).
    - effectively connects user requests to
      - infrastructure running in AWS (EC2 instances, ELB load balancers, or S3 buckets…)
      - infrastructure that is outside of AWS.

  - Health checking of resources.
    - verify Internet connected resources are reachable, available and functional.
    - check the instance health by connecting to it.
    - A health check can monitor the health of an HTTP or HTTPS page every 30 / 10 seconds.
    - Health checks can be pointed at:
      - A / multiple Endpoints.
      - Status of other health checks.
      - Status of a CloudWatch alarm.

  - Private DNS
    - lets you have 有权威的 authoritative DNS within your VPCs without exposing your DNS records
    - (including the name of the resource and its IP address(es) to the Internet.

  - reliable:
    - distribute loads across Regions
    - it has redundant locations
    - backed with 100% SLA

  - fast
    - utilizes worldwide anycast
      - network addressing and routing methodology
      - in which a single destination address has multiple routing paths
    - changes are quickly propagated 增殖

  - Easy use:
    - accessible via the AWS console or programmatic APIs.  
    - Domain name management

  - Cost-effective:
    - Inexpensive
    - pay-as-you-go model.

  - Intergrated with AWS:
    - ELB-Alias Queries
    - set up latency-based routing
    - customers will be directed to the fastest server based on latency.  

  - Flexible:
    - use geolocation rounding
    - helpful for business where data has to stay in the country of origin.
    - For example, if a customer originates in Germany, their network traffic never leaves Germany.
    - Weighted round robin, WRR
    - Self-aliasing

  - fully compliant with IPv6.

- use Amazon Route 53 to configure DNS health checks so you that can route traffic to healthy endpoints or independently monitor the health of your application and its endpoints.
- Amazon Route 53 traffic flow helps you manage traffic globally through several routing types, which can be combined with DNS failover to enable various low-latency, fault-tolerant architectures.
- use Amazon Route 53 traffic flow’s simple visual editor to manage how your users are routed to your application’s endpoints—whether in a single AWS Region or distributed around the globe.

---

### ROUTING POLICIES
- determine how Route 53 responds to queries.
- The following table highlights the key function of each type of routing policy:


- Simple routing (round robin)
  - a single record within a hosted zone that contains one or more values.
  - for a single resource that performs a given function for your domain
  - Simple routing in / distribute load to a single server environment
  - such as a web server that serves content for the example.com website
  - Route 53 responds to DNS queries based only on the values in the resource record set
  - like the IP address in an A record
  - An A record is associated with one or more IP addresses.
  - When queried, a simple routing policy record returns all the values in a randomized order.
  - Uses round robin.
  - Does not support health checks.

- Weighted round robin routing WWR
  - a network scheduling discipline 纪律
  - Weighted routing policies are based on the weight of each record and total weight of associated weighted records.
  - the number of packets served is in proportion to the assigned weight, and in inverse proportion to the size of the packets.
  - specify a weight per IP address
  - create records that have the same name and type and assign each record a relative weight.
  - Numerical value that favours one IP over another.
  - Weights can be any number between 0 and 255
  - To stop sending traffic to a resource: change the weight of the record to 0.
  - route traffic to multiple resources in proportions 均衡 that you specify.
  - assign weights to resource record sets, to specify the desired access frequency with which different responses are served.
  - Example:
  - You might want to use this capability to do A/B testing
  - testing a new application
  - send a small portion of traffic to a server where you made a software change, see if it works.
  -  send a small amount of that traffic to your new application to see if everything is working properly
  - have two record sets that are associated with one DNS name: one with weight 3 and one with weight 1.
  - 75 percent of the time, Amazon Route 53 will return the record set with weight 3
  - 25 percent of the time, Amazon Route 53 will return the record set with weight 1.


- Latency routing (LBR)
  - For every record that you created that uses latency-based routing, you specify the region.
  - resources in multiple AWS Regions
  - route traffic to the Region that provides the best latency.
  - Fastest connection to the application.
  - Provides the fastest experience nased on actual performance measurements of the different AWS regions where app in running.
  - Improve application’s performance for a global audience.
  - routing your customers to the AWS endpoint (for example, EC2 instances, Elastic IP addresses, or load balancers) that provides the fastest experience based on actual performance measurements of the different AWS Regions where your application runs.
  - improving performance by routing to the region with the lowest latency.
  - create latency records for resources in multiple EC2 locations.
  - Route 53 consults a latency database each time a request occurs to a given latency-based host in DNS from the resolver server.


- Geolocation routing
  - choose the resources that serve your route traffic based on
  - the location of your users.
  - Or the origin of the DNS queries.
  - Can be used for spreading load evenly between regions.
  - If you have multiple records for overlapping regions, Route 53 will route to the smallest geographic region.
  - can create a default record for IP addresses that do not map to a geographic location.
  - If a requestor's IP can't be placed to a geographic location or no record exists for that location, they will receive a defaulted version of a website (if a default record is placed).
  - can localize your content:
  - present different content to users in different geographic regions.
  - present website in the language of your users.
  - Caters to different users in different countries and different languages.
  - Contains users within a particular geography and offers them a customized version of the workload based on their specific needs.
  - Can also protect distribution rights.
  - restrict the distribution of content to only the locations where have distribution rights.
  - balancing the load across endpoints in a predictable, easy-to-manage way,
  - so that each user location is consistently routed to the same endpoint.
  - If multiple Geolocation records are present for overlapping regions, it will route based on the most specific path to its user's location.
  - priority goes to the smallest geographic region, specific of the requestor.


- Geoproximity routing (requires Route Flow):
  - route traffic based on the distances between users and your resources if you're using Route 53 traffic flow
  - and, optionally, shift traffic from resources in one location to resources in another.
  - can route more or less traffic to each resource by specifying a positive or negative bias.
  - In AWS, When create a traffic flow policy, you can specify either an AWS Region, or the latitude and longitude for each endpoint


- Failover routing (DNS failover)
  - Failover routing allows you to create 2 records with the same name.
  - Use when you want to configure active-passive failover.
  - Associated with a health check.
  - track the health status of your resources and take action when an error occurs.
  - Routes only when the resource is healthy.
  - help detect an outage of your website and redirect your users to alternate locations where your application is operating properly.
  - health-checking agents will monitor each locationor endpoint of your application to determine its availability.
  - Creating health checks to monitor the health and performance of your web applications, web servers, and other resources.
  - Each health check that you create can monitor one of the following
  - the health of a specified resource, such as a web server;
  - the status of other health checks;
  - the status of an Amazon CloudWatch alarm.
  - Can be used with ELB.
  - You can take advantage of this feature to
  - increase the availability of your customer-facing application.
  - Configuring backup and failover scenarios for your own applications.
  - Enabling highly available multi-Region architectures on AWS.
  - configure backup and failover scenarios for your applications with Route 53
	⁃
  - The process of configuring these Route 53 settings is minimal
  - improve health checks by combining multiple health checks, using domain name interval.
  - string matching: the health check looks for a particular string in the page body, within the first 5 KB of content.
  - could use string matching to confirm whether the DB instance is working by matching on a string that the page would contain only if it successfully connects to the DB.
  - When used with Alias records set Evaluate Target Health to “Yes” and do not use health checks.
  - Failover to the static backup site would then be triggered in the following situations:
  - the web server goes down,
  - the DB instance goes down,  
  - if the web server hangs,
  - or if the web server returns invalid content
  - example of how DNS failover works in a typical architecture for a multi-tiered web app
  - Route 53 passes traffic to an ELB load balancer, which then passes the traffic to a fleet of EC2 instances that use Auto Scaling.
  - do the following tasks with Route 53 to ensure high availability
  - 1. create two DNS records for the CNAME www with a routing policy of Failover Routing.
  - The first record is the primary, points to the ELB load balancer for web application.
  - The second record is the “Secondary” route policy, points to your static Amazon S3 website.
  - If something happened to the primary link, traffic would automatically be redirected to the static website that’s hosted in the S3 bucket.
  - Failover to a secondary IP address.
  - Use Route 53 health checks to make sure the primary is up.
  - If is the primary is up, all traffic will default to your web application stack.
	⁃
	⁃

- Multivalue answer routing
  - configure Amazon Route53 to return multiple values (like IP addresses for your web servers) in response to DNS queries.
  - route traffic approximately randomly to multiple resources,
  - Iike web servers, you can create one multivalue answer record for each resource
  - associate an Amazon Route 53 health check with each record
  - configure Route 53 to return multiple health-checkable IP addresses so can use DNS to improve availability and load balancing.
  - Use when you want Route53 to respond to DNS queries with up to 8 healthy records that selected at random.
  - can specify multiple values for almost any record,
  - enables to check the health of each resource so that Route53 returns only values for healthy resources.
  - not a substitute for a load balancer
  - but the ability to return multiple health-checkable IP addresses is a way to use DNS to improve availability and load balancing.
  - Example
  - manage an HTTP web service with a dozen web servers that each have their own IP address.
  - No one web server could handle all of the traffic,
  - create a dozen multivalueanswer records, Amazon Route 53 responds to DNS queries with up to eight healthy records in response to each DNS query.
  - Amazon Route 53 gives different answers to different DNS resolvers.
  - If a web server becomes unavailable after a resolver caches a response, client software can try another IP address in the response.



---

Multi-Region deployment.
- two deployments
- one in the us-west-2 Region on the west coast of the United States,
- one in the Asia Pacific Southeast Region.
- Both load balancers will respond to http://amgogreen.com .
- The load balancers will direct the user to the closest http://amgogreen.com.  
- offers a better user experience.
- If the west coast site went down, all traffic would automatically be redirected to the Asia Pacific Southeast domain.

Benefits include:
- Latency-based routing to the Region
- And load balancing routing to the Availability Zone

  - hosted zone
	⁃

  - Allows for a private (internal) version of a website while using the same domain name as a public website
  - Private zones are associated with VPCs.
  - allows these VPCs to see a version of a website specified by the private zone's A record.
Hosted Zones
- control management access to your Route 53 hosted zone by using IAM.
- a collection of records for a specified domain.
- analogous 相似的 to a traditional DNS zone file;
  - it represents a collection of records that can be managed together.
- 2 types of zones:
  - maintain both a private and public hosted zone with the same domain name for split-view DNS with Route 53.
  - Allows for a private (internal) version of a website while using the same domain name as a public website
  - Public host zone
  - determines how traffic is routed on the Internet.
  - The host (www) portion is not included in a public zone's naming convention.
  - Private hosted zone for VPC
  - determines how traffic is routed within VPC (resources are not accessible outside the VPC)
  - allows these VPCs to see a version of a website specified by the private zone's A record.
- Route 53 automatically creates the Name Server (NS) and Start of Authority (SOA) records for the hosted zones.
- Amazon Route 53 creates a set of 4 unique name servers (a delegation set) within each hosted zone.
- You can create multiple hosted zones with the same name and different records.
- NS servers are specified by Fully Qualified Domain Name (FQDN)
  - can get the IP addresses from the command line (e.g. dig or nslookup).
- For private hosted zones you can see a list of VPCs in each region and must select one.
- For private hosted zones you must set the following VPC settings to “true”:
  - Enable DnsHostname.
  - Enable DnsSupport.
- You also need to create a DHCP options set.
- Endpoints can be IP addresses or domain names.

RECORDS
- Amazon Route 53 currently supports the following DNS record types:
  - A (address record).
  - AAAA (IPv6 address record).
  - CNAME (canonical name record).
  - CAA (certification authority authorization).
  - MX (mail exchange record).
  - NAPTR (name authority pointer record).
  - NS (name server record).
  - PTR (pointer record).
  - SOA (start of authority record).
  - SPF (sender policy framework).
  - SRV (service locator).
  - TXT (text record).
  - Alias (Amazon Route 53-specific virtual record).
  - Alias records are used to map resource record sets in your hosted zone to ELB load balancers, CloudFront distributions, Elastic Beanstalk environments, or S3 buckets that are configured as websites.
  - can use Alias records to map custom domain names (such as api.example.com) both to API Gateway custom regional APIs and edge-optimized APIs and to Amazon VPC interface endpoints.
  - The Alias is pointed to the DNS name of the service.
  - You cannot set the TTL for Alias records for ELB, S3, or Elastic Beanstalk environment (is service’s default).
  - Alias records work like a CNAME record in that you can map one DNS name (e.g. example.com) to another ‘target’ DNS name (e.g. elb1234.elb.amazonaws.com).
  - can be used for resolving apex / naked domain names (e.g. example.com rather than sub.example.com).
  - CNAME record can’t be used for resolving apex / naked domain names.
  - Generally use an Alias record where possible. The following table details the differences between Alias and CNAME records:
	⁃
  - Route 53 supports wildcard entries for all record types, except NS records.


TRAFFIC FLOW
- Route 53 Traffic Flow provides Global Traffic Management (GTM) services.
- Traffic flow policies allow to
  - create routing configurations for resources using routing types such as failover and geolocation.
  - Create policies that route traffic based on specific constraints, including latency, endpoint health, load, geo-proximity and geography.
  - includes a versioning feature that allows to maintain history of changes of routing policies, easy roll back to previous policy version using the console or API.
- Scenarios include:
  - Add a simple backup page in Amazon S3 for a website.
  - Building sophisticated routing policies that consider an end user’s geographic location, proximity to an AWS region, and the health of each of your endpoints.


ROUTE 53 RESOLVER
- a set of features enable bi-directional querying between on-premises and AWS over private connections.
  - for enabling DNS resolution for hybrid clouds.
- Inbound query capability is provided by Route 53 Resolver Endpoints,
  - allowing DNS queries that originate on-premises to resolve AWS hosted domains.
  - Connectivity needs to be established between your on-premises DNS infrastructure and AWS through a Direct Connect (DX) or a Virtual Private Network (VPN).
  - Endpoints are configured through IP address assignment in each subnet for which you would like to provide a resolver.
	⁃
- Conditional forwarding rules:
  - Outbound DNS queries are enabled through the use of Conditional Forwarding Rules.
  - Domains hosted within your on-premises DNS infrastructure can be configured as forwarding rules in Route 53 Resolver.
  - Rules will trigger when a query is made to one of those domains
  - and will attempt to forward DNS requests to your DNS servers configured along with the rules.
  - Like the inbound queries, this requires a private connection over DX or VPN.
	⁃

### CHARGES
- You pay per hosted zone per month (no partial months).
- A hosted zone deleted within 12 hours of creation is not charged (queries are charges).
- Additional charges for:
  - Queries.
  - Traffic Flow.
  - Health Checks.
  - charged with different prices for AWS vs non-AWS endpoints.
  - Route 53 Resolver ENIs + queries.
  - Domain names.
- Alias records are free of charge when the records are mapped to one of the following:
  - Elastic Load Balancers.
  - Amazon CloudFront distributions.
  - AWS Elastic Beanstalk environments.
  - Amazon S3 buckets that are configured as website endpoints.
- You do not pay for the records that you add to your hosted zones.
- Latency-based routing queries are more expensive.
- Geo DNS and geo-proximity also have higher prices.



---


## DNS over HTTPS

Normally when you request a domain name such as google.com
- you send out an `unencrypted DNS request` to find the IP Address the domain resolves to (so your machine can connect to the domain.)
- A relatively modern replacement for **traditional DNS** is **DNS over HTTPS (DoH)**.
  - DoH encrypts `DNS queries`, and sends the requests out as regular HTTPS traffic to DoH resolvers.


Using DoH
- a fairly unusual choice for the Denonia authors
- provides two disadvantages here:
  - AWS cannot see the dns lookups for the malicious domain, reducing the likelihood of triggering a detection
  - Some Lambda environments may be unable to perform DNS lookups, depending on VPC settings.












.
