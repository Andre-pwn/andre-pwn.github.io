---
title: AWS - API call
date: 2020-07-18 11:11:11 -0400
categories: [01AWS, boto3]
tags: [AWS]
toc: true
image:
---


- [AWS - API call](#aws---api-call)
  - [rds](#rds)
  - [ec2](#ec2)
  - [codepipeline](#codepipeline)
  - [permission](#permission)
  - [ssm](#ssm)
  - [kinesis](#kinesis)
  - [kms](#kms)
  - [config](#config)
  - [elasticache](#elasticache)
  - [sqs](#sqs)
  - [audit manager](#audit-manager)
  - [access analyzer](#access-analyzer)
  - [appmesh](#appmesh)
  - [accessanalyzer](#accessanalyzer)
  - [OU](#ou)
  - [RAM](#ram)
  - [License manager](#license-manager)
  - [code guru](#code-guru)
  - [dynamodb](#dynamodb)


---

# AWS - API call

---

## rds

```bash
aws configservice select-resource-config \
    --expression "SELECT resourceId WHERE resourceType='AWS::EC2::Instance'"

aws configservice put-stored-query \
    --stored-query "{\"QueryName\": \"cli-test\", \"Expression\": \"SELECT *\", \"Description\": \"cli test query\" }" \
    --tags "[{ \"Key\": \"first-tag\", \"Value\": \"\" }, { \"Key\": \"second-tag\", \"Value\": \"non-empty-tag-value\" }]"


```


## ec2

```bash
aws ec2 create-vpc \
	--cidr-block 10.0.0.0/16

aws ec2 create-subnet \
	--vpc-id vpc-2f09a348 \
	--cidr-block 10.0.1.0/24

aws ec2 describe-subnets \
	--filters "Name=vpc-id,Values=vpc-2f09a348" \
	--query 'Subnets[*].{ID:SubnetId,CIDR:CidrBlock}'


aws ec2 create-internet-gateway

aws ec2 attach-internet-gateway \
	--vpc-id vpc-2f09a348 \
	--internet-gateway-id igw-1ff7a07b

aws ec2 create-route-table \
	--vpc-id vpc-2f09a348

aws ec2 create-route \
	--route-table-id rtb-c1c8faa6 \
	--destination-cidr-block 0.0.0.0/0 \
	--gateway-id igw-1ff7a07b

aws ec2 describe-route-tables \
	--route-table-id rtb-c1c8faa6

aws ec2 associate-route-table  \
	--subnet-id subnet-b46032ec \
	--route-table-id rtb-c1c8faa6

aws ec2 modify-subnet-attribute \
	--subnet-id subnet-b46032ec \
	--map-public-ip-on-launch


aws ec2 describe-instances \
    | jq -r .'Reservations[].Instances[].Tags.Keys | select(.Keys==name).Value'


aws ec2 describe-instances \
    --instance-ids i-0cd08439083be3097 \
    | jq -r .'Reservations[].Instances[].Tags.Keys | select(.Keys==name).Value'



aws ec2 describe-instances \
    --region us-west-2 \
    | jq -r .'Reservations[].Instances[] | select(.ImageId=="ami-079c15a5dce1efcc5")' \
    | grep -e 'InstanceId' -e 'Value'

aws ec2 describe-instances \
    --region us-west-1 \
    | jq -r .'Reservations[].Instances[] | select(.ImageId=="ami-01185a3f98b54ddf1")' \
    | grep -e 'InstanceId' -e 'Value'


aws ec2 describe-instances \
    --region us-east-1 \
    | jq -r .'Reservations[].Instances[] | select(.ImageId=="ami-01185a3f98b54ddf1")' \
    | grep -e 'InstanceId' -e 'Value'


aws ec2 describe-instances \
    --instance-ids i-0ddf4c8537aafa386 \
    | jq -r '.Reservations[].Instances[]' \
    | grep -e 'SubnetId' -e 'Value'





aws ec2 describe-subnets \
    --subnet-ids subnet-0f6c01bdf2a83d23f


```


## codepipeline


```
aws codepipeline start-pipeline-execution \
	--name account-setup-pipeline

```


## permission

```
aws iam attach-user-policy \
	--policy-arn arn:aws:iam:ACCOUNT-ID:aws:policy/AdministratorAccess \
	--user-name admin

aws iam attach-role-policy \
    --policy-arn arn:aws:iam::665356936107:policy/MWAA-test-AmazonMWAAWebServerAccess \
    --role-name admin

aws iam detach-role-policy \
	--policy-arn arn:aws:iam::665356936107:policy/MWAA-test-AmazonMWAAWebServerAccess \
    --role-name admin
```




## ssm

```bash
aws ssm send-command \
	--document-name "AWS-ApplyAnsiblePlaybooks" \
	--document-version "1" \
	--parameters '{ "SourceType":["GitHub/S3"], \
					"SourceInfo":["{}"], \
					"InstallDependencies":["True"], \
					"PlaybookFile":["hello-world-playbook.yml"], \
					"ExtraVariables":["SSM=True"], \
					"Check":["False"], \
					"Verbose":["-v"], \
					"TimeoutSeconds":["3600"]}' \
	--timeout-seconds 600 \
	--max-concurrency "50" \
	--max-errors "0" \
	--region us-west-2

aws ssm send-command \
	--document-name "AWS-InstallApplication" \
	--document-version "1" \
	--parameters '{ "action":["Install/Uninstall"], \
					"parameters":[""], \
					"sourceHash":[""]}' \
	--timeout-seconds 600 \
	--max-concurrency "50" \
	--max-errors "0" \
	--region us-west-2


aws ssm list-documents


aws ssm delete-document \
	--name test-ssm-role


aws ssm list-documents \
    --filters Key=Owner,Values=Self, Amazon, Public, Private, ThirdParty, All, Default


aws ssm start-automation-execution \
    --document-name "AWS-UpdateLinuxAmi" \
    --parameters "AutomationAssumeRole=arn:aws:iam::123456789012:role/SSMAutomationRole,SourceAmiId=ami-EXAMPLE,IamInstanceProfileName=EC2InstanceRole"

aws ssm start-automation-execution \
     --document-name test-ssm-role \
     --parameters "BucketName=test-ssm-role-public"


aws ssm get-parameters-by-path \
	--recursive \
	--path /customer/endpoints/ | jq '.Parameters[].Name'



aws ssm get-parameters-by-path \
	--recursive \
	--path /customer/endpoints/ | jq '.Parameters[] | select(.Value | contains("false")).Name'


aws ssm put-parameter \
    --name "/customer/endpoints/apple/artifacts" \
    --value true \
    --type String \
    --overwrite



# for ssm agent !!!!!!!!!!
# If the describe-instance-information command output returns an empty array (i.e. no SSM managed instance information), as shown in the output example above, the selected Amazon EC2 instance is not managed using AWS Systems Manager (SSM) service.
aws ssm describe-instance-information \
	--instance-information-filter-list 'key=InstanceIds,valueSet=i-0ef74b8ec6283d745' \
	--query 'InstanceInformationList'
# [
#     {
#         "InstanceId": "i-0ef74b8ec6283d745",
#         "PingStatus": "Online",
#         "LastPingDateTime": "2021-08-09T10:22:07.236000-05:00",
#         "AgentVersion": "3.0.1390.0",
#         "IsLatestVersion": false,
#         "PlatformType": "Linux",
#         "PlatformName": "Amazon Linux",
#         "PlatformVersion": "2",
#         "ResourceType": "EC2Instance",
#         "IPAddress": "172.31.210.46",
#         "ComputerName": "ip-172-31-210-46.us-west-2.compute.internal",
#         "AssociationStatus": "Success",
#         "LastAssociationExecutionDate": "2021-08-09T10:00:20.179000-05:00",
#         "LastSuccessfulAssociationExecutionDate": "2021-08-09T10:00:20.179000-05:00",
#         "AssociationOverview": {
#             "InstanceAssociationStatusAggregatedCount": {
#                 "Success": 1
#             }
#         }
#     }
# ]
aws ssm describe-instance-information \
	--instance-information-filter-list 'key=InstanceIds,valueSet=i-00a51a1dcb10099c3' \
	--query 'InstanceInformationList'
# []

# for ssm agent
aws ssm get-inventory \
    --filters 'Key=string, Values="Connection Lost", Type=string' \
    | jq -r


aws ssm get-inventory \
    --filters 'Key="AWS:AWSComponent.Name", Values=[amazon-ssm-agent], Type=Equal' \
    | jq -r




# for ssm agent
aws ssm list-inventory-entries \
    --instance-id 'i-06de5ab3a6daa0a4f' \
    --type-name 'AWS:AWSComponent' \
    --filters 'Key=Name, Values=[amazon-ssm-agent], Type=Equal' \
    | jq -r


# wrong/non-existed instance ID
aws ssm list-inventory-entries \
    --instance-id 'i-06de5ab3ssssss4f' \
    --type-name 'AWS:AWSComponent' \
    --filters 'Key=Name, Values=[amazon-ssm-agent], Type=Equal' \
    | jq -r
# {
#   "TypeName": "AWS:AWSComponent",
#   "InstanceId": "i-06de5ab3sssssss4f",
#   "Entries": []
# }


aws ssm list-inventory-entries \
    --instance-id 'arn:aws:ec2:us-west-2:665356936107:instance/i-06de5ab3ssssss4f' \
    --type-name 'AWS:AWSComponent' \
    --filters 'Key=Name, Values=[amazon-ssm-agent], Type=Equal' \
    | jq -r



# for application
aws ssm list-inventory-entries \
    --instance-id 'i-06de5ab3a6daa0a4f' \
    --type-name 'AWS:Application' \
    --filters 'Key=Name, Values=[td-agent, vector, qualys-cloud-agent, artemisd], Type=Equal' \
    | jq -r | grep td-agent


# for application
aws ssm list-inventory-entries \
    --instance-id 'i-010d04f30ba7703e8' \
    --type-name 'AWS:Application' \
    --filters 'Key=Name, Values=[artemisd,], Type=Equal' \
    | jq -r

 # for application
aws ssm list-inventory-entries \
    --instance-id 'i-0034fd77d40594d20' \
    --type-name 'AWS:Application'

```

---

## kinesis



```bash

aws configservice delete-evaluation-results \
    --config-rule-name ais-sa-audit-require-kinesisstream-sse-Rule-17B8RJSRMFRHX


RULE_NAME=ec2-app-check-Rule-YFGF2Z5110JU

aws configservice get-compliance-details-by-config-rule \
    --config-rule-name $RULE_NAME \
    --compliance-types NON_COMPLIANT \
    | jq -r '.EvaluationResults[].EvaluationResultIdentifier.EvaluationResultQualifier.ResourceId'

## -------------------------- SSM doc
# Run the SSM doc
automoatinID=$( aws ssm start-automation-execution \
                    --document-name ais-ssm-encrypt-kinesis-stream \
                    --parameters "TargetKinesisStreamName = test-grace" \
                    | jq -r '.AutomationExecutionId' )
# {
#     "AutomationExecutionId": "fb4140f7-c87d-4830-8531-7a6bf3263efe"
# }

echo $automoatinID
# "fb4140f7-c87d-4830-8531-7a6bf3263efe"

## get SSM doc output
aws ssm get-automation-execution \
    --automation-execution-id $automoatinID \
    | jq -r '.AutomationExecution.Outputs'


##  -------------------------- aws kinesis cli
# list all current streams
aws kinesis list-streams \
	--query 'StreamNames'

## check the SSE encryption key for kinesis stream
aws kinesis describe-stream \
	--stream-name test-grace \
	--query 'StreamDescription'

aws kinesis describe-stream \
	--stream-name test-grace \
	--query 'StreamDescription.KeyId'

aws kinesis describe-stream \
	--stream-name test-grace \
	# | grep -e 'StreamDescription.KeyId' -e 'KeyId'
    # | jq -r '.StreamDescription | (.EncryptionType, .KeyId)'

## to start a encryption
aws kinesis start-stream-encryption \
    --encryption-type KMS \
    --key-id arn:aws:kms:us-west-2:012345678912:key/a3c4a7cd-728b-45dd-b334-4d3eb496e452 \
    --stream-name test-grace


aws kinesis list-domain-names

aws kinesis describe-elasticsearch-domain \
	--domain-name test-grace \
	--query 'DomainStatus.EncryptionAtRestOptions'



aws kinesis put-record \
	--stream-name test-grace \
	--partition-key 123 \
	--data testdata
{
    "ShardId": "shardId-000000000000",
    "SequenceNumber": "49616678361237150307572272936652471188365631880943370242"
}

aws kinesis get-shard-iterator \
	--shard-id shardId-000000000000 \
	--shard-iterator-type TRIM_HORIZON \
	--stream-name test-grace
{
    "ShardIterator": "AAAAAAAAAAGRThQ/BPNyJX4FgoEUHFwd4A+zgej3a7SB6SVTI8LMQI/89VDIZemEXTYUINVG/KcovzH6Ypx4hv1stIb25qw0MysO7rdgTnZqTmYG1dQYziytTj4yXMQCXgoeQtFrg2MTqr5/rmtVNv2ZBKkuijEK3c4xnwRDAWKUIYs33MVJdbem3jLiNZcVzBb8hzYbFVNbEkpX31XVrgjLEHTV8yaIRF4aEpqsEB4vAe8zvk+CaEyoQv9gQLF71184lXg060U="
}


aws kinesis get-records \
	--shard-iterator AAAAAAAAAAGRThQ/BPNyJX4FgoEUHFwd4A+zgej3a7SB6SVTI8LMQI/89VDIZemEXTYUINVG/KcovzH6Ypx4hv1stIb25qw0MysO7rdgTnZqTmYG1dQYziytTj4yXMQCXgoeQtFrg2MTqr5/rmtVNv2ZBKkuijEK3c4xnwRDAWKUIYs33MVJdbem3jLiNZcVzBb8hzYbFVNbEkpX31XVrgjLEHTV8yaIRF4aEpqsEB4vAe8zvk+CaEyoQv9gQLF71184lXg060U=
{
    "Records": [
        {
            "SequenceNumber": "49616678361237150307572272936652471188365631880943370242",
            "ApproximateArrivalTimestamp": 1616597017.932,
            "Data": "dGVzdGRhdGE=",
            "PartitionKey": "123"
        }
    ],
    "NextShardIterator": "AAAAAAAAAAHv2CdC1wUc/A5l2cVCqkXAPe12NhJYC0CtUIxJPbtDbph2sQH7whU9RP6e5/NpoV3kxv2ZxNw2tmMRFyCmGHkjdUcJUBtT0oVCszm2aI5dPAW0yuZXO1h2UDWadpq5QWMPhnSEMxsPioJlKzgZEBGn/aE6c1QFrP8HhYW/v0+2ZLODPPguuif+NeTSPbBOdbNU+bbwoFfs21xvkBp6agFmEG0sroYA8Qobxoq9BglQcpgyCbwXEtedWZG9i1qvgfQ=",
    "MillisBehindLatest": 0
}


$ RULE_NAME=$(aws configservice describe-config-rules \
    | jq -r '.ConfigRules[] | select(.ConfigRuleName | contains("ais-sa-audit-require-kinesisstream-sse")).ConfigRuleName')

$ NONCOMPLIANT_RESOURCES=$(aws configservice get-compliance-details-by-config-rule \
    --config-rule-name $RULE_NAME \
    --compliance-types NON_COMPLIANT \
    | jq -r '.EvaluationResults[].EvaluationResultIdentifier.EvaluationResultQualifier.ResourceId')

$ echo $NONCOMPLIANT_RESOURCES

while IFS= read -r line;
    do echo "$line";
    done <<< "$NONCOMPLIANT_RESOURCES"


while IFS= read -r line;
    do aws kinesis describe-stream \
    --stream-name "$line" \
    | jq -r | grep -e 'StreamName' -e 'EncryptionType';
    done <<< "$NONCOMPLIANT_RESOURCES"


aws kinesis describe-stream \
    --stream-name "$line" \
    | jq -r | grep -e 'StreamName' -e 'EncryptionType'
```


---


## kms


```bash
aws kms list-keys \
	--query 'Keys[KeyArn]'


aws kms describe-key \
	--key-id c277ab7a-49a2-41ed-abda-7741ed0dc02f


aws kms describe-key \
	--key-id arn:aws:kms:us-west-2:665356936107:alias/aws/kinesis

!Sub 'arn:aws:kms:${AWS::Region}:${AWS::AccountId}:alias/aws/kinesis'

## not work
aws kms describe-key \
	--key-id aws/kinesis

aws kms describe-key \
	--key-id arn:aws:kms:us-west-2:665356936107:key/c277ab7a-49a2-41ed-abda-7741ed0dc02f
```


## config

```bash
# check NON_COMPLIANT
$ RULE_NAME=$(aws configservice describe-config-rules \
    | jq -r '.ConfigRules[] | select(.ConfigRuleName | contains("ais-require-tagging-compliance-rule")).ConfigRuleName')

$ aws configservice get-compliance-details-by-config-rule \
    --config-rule-name $RULE_NAME \
    --compliance-types NON_COMPLIANT \
    | jq -r '.EvaluationResults[].EvaluationResultIdentifier.EvaluationResultQualifier.ResourceId'

aws configservice get-compliance-details-by-config-rule \
    --config-rule-name "test-managed-cmk-backing-key-rotation-enabled-AISConfigRules" \
    --compliance-types NON_COMPLIANT \
    | jq -r '.EvaluationResults[]'

aws configservice get-compliance-details-by-config-rule \
    --config-rule-name "test-managed-rds-logging-enabled-AISConfigRules" \
    --compliance-types NON_COMPLIANT \
    | jq -r '.EvaluationResults[].EvaluationResultIdentifier.EvaluationResultQualifier.ResourceId'


## describe-config-rules
aws configservice describe-config-rules \
	--output text \
	--query 'ConfigRules[].[ConfigRuleName]' | grep -F 'conformance-pack' | sort -u

aws configservice describe-config-rules \
	--output json \
    | grep -F 'ConfigRuleName' | sort -u | grep "rds"

aws configservice describe-config-rules \
    | jq -r '.ConfigRules[] | select(.ConfigRuleName == "test-managed-rds-logging-enabled-AISConfigRules") '



## describe-conformance-packs
aws configservice describe-conformance-packs \
	| grep ConformancePackName

aws configservice describe-organization-conformance-packs \


CONFIG_PACK=$(aws configservice describe-conformance-packs | jq -r '.ConformancePackDetails' | jq -r '.[].ConformancePackName')
ARRAY=(`echo $CONFIG_PACK | sed 's/,/\n/g'`)
for index in $ARRAY
do
	aws configservice delete-conformance-pack --conformance-pack-name $index
done

echo 1
echo 2
echo 3



$ while read region; do aws configservice put-organization-conformance-pack \
							--organization-conformance-pack-name="ManagedRules1" \
							--template-body="file://managed-rules-1.yaml" \
							--delivery-s3-bucket="awsconfigconforms-main" \
							--region ${region} \
					 && aws configservice put-organization-conformance-pack \
					 		--organization-conformance-pack-name="ManagedRules2" \
						 	--template-body="file://managed-rules-2.yaml" \
							 --delivery-s3-bucket="awsconfigconforms-main" \
							 --region ${region} \
					 ; done < <(awk '{print $NF}' /tmp/r)



## conference pack region
$ sudo vim /tmp/r
ap-northeast-2
ap-southeast-1
ap-southeast-2
ap-northeast-1
ap-south-1
ca-central-1
eu-central-1
eu-west-1
eu-west-2
eu-west-3
eu-north-1
sa-east-1
us-east-1
us-east-2
us-west-1
us-west-2

$ cat /tmp/r

awk '{print $NF}' /tmp/r | head -n 4

while read region; do echo ${region} ;
	done < <(awk '{print $NF}' /tmp/r)


while read region; do aws configservice describe-organization-conformance-pack-statuses --region ${region} ;
	done < <(awk '{print $NF}' /tmp/r)


## update
while read region; do aws configservice put-organization-conformance-pack \
        --organization-conformance-pack-name="ManagedRules1" \
        --template-body="file://managed-rules-1.yaml" \
        --delivery-s3-bucket="awsconfigconforms-main" \
        --region ${region}
        done < <(awk '{print $NF}' /tmp/r)
# An error occurred (ResourceInUseException) when calling the PutOrganizationConformancePack operation: AWS resource is currently in use. Try your request again later.
# {"OrganizationConformancePackArn": "arn:aws:config:ap-southeast-1:115215104958:organization-conformance-pack/ManagedRules1-zmvq0tfx"}
# {"OrganizationConformancePackArn": "arn:aws:config:ap-southeast-2:115215104958:organization-conformance-pack/ManagedRules1-ayzs22np"}
# {"OrganizationConformancePackArn": "arn:aws:config:ap-northeast-1:115215104958:organization-conformance-pack/ManagedRules1-yqq0tgw5"}
# {"OrganizationConformancePackArn": "arn:aws:config:ap-south-1:115215104958:organization-conformance-pack/ManagedRules1-lx29ih5c"}
# {"OrganizationConformancePackArn": "arn:aws:config:ca-central-1:115215104958:organization-conformance-pack/ManagedRules1-ghae6hm9"}
# {"OrganizationConformancePackArn": "arn:aws:config:eu-central-1:115215104958:organization-conformance-pack/ManagedRules1-8abgeswj"}
# {"OrganizationConformancePackArn": "arn:aws:config:eu-west-1:115215104958:organization-conformance-pack/ManagedRules1-cddwbdlg"}
# {"OrganizationConformancePackArn": "arn:aws:config:eu-west-2:115215104958:organization-conformance-pack/ManagedRules1-vo5tjmtx"}
# {"OrganizationConformancePackArn": "arn:aws:config:eu-west-3:115215104958:organization-conformance-pack/ManagedRules1-xzqe9vke"}
# {"OrganizationConformancePackArn": "arn:aws:config:eu-north-1:115215104958:organization-conformance-pack/ManagedRules1-achfo7nc"}
# {"OrganizationConformancePackArn": "arn:aws:config:sa-east-1:115215104958:organization-conformance-pack/ManagedRules1-sntcyze0"}
# {"OrganizationConformancePackArn": "arn:aws:config:us-east-1:115215104958:organization-conformance-pack/ManagedRules1-aogvjkda"}
# {"OrganizationConformancePackArn": "arn:aws:config:us-east-2:115215104958:organization-conformance-pack/ManagedRules1-sgei9nsq"}
# {"OrganizationConformancePackArn": "arn:aws:config:us-west-1:115215104958:organization-conformance-pack/ManagedRules1-9xkuxayv"}
# {"OrganizationConformancePackArn": "arn:aws:config:us-west-2:115215104958:organization-conformance-pack/ManagedRules1-zfbam2vu"}


## delete
while read region; do aws configservice delete-organization-conformance-pack \
    --organization-conformance-pack-name ManagedRules2 \
	--region ${region}
	done < <(awk '{print $NF}' /tmp/r)

aws configservice delete-organization-conformance-pack \
	--organization-conformance-pack-name ManagedRules2

aws configservice delete-conformance-pack \
	--conformance-pack-name OrgConformsPack-ManagedRules2-6jdgmlwe



## get-organization-conformance-pack-detailed-status

while read region; do aws configservice describe-organization-conformance-pack-statuses \
        --region ${region}
        done < <(awk '{print $NF}' /tmp/r)

aws configservice describe-organization-conformance-pack-statuses \
	--region us-west-2
# {
#     "OrganizationConformancePackStatuses": [
#         {
#             "OrganizationConformancePackName": "ManagedRules1",
#             "Status": "UPDATE_FAILED",
#             "ErrorCode": "InternalError",
#             "ErrorMessage": "One or more member accounts failed to process your request. Use the GetOrganizationConformancePackDetailedStatus API to retrieve detailed error status for each member account.",
#             "LastUpdateTime": "2021-05-18T22:50:13.265000-05:00"
#         },
#         {
#             "OrganizationConformancePackName": "ManagedRules2",
#             "Status": "DELETE_FAILED",
#             "ErrorCode": "InternalError",
#             "ErrorMessage": "One or more member accounts failed to process your request. Use the GetOrganizationConformancePackDetailedStatus API to retrieve detailed error status for each member account.",
#             "LastUpdateTime": "2021-05-18T15:46:12.636000-05:00"
#         }
#     ]
# }



## get-organization-conformance-pack-detailed-status
aws configservice get-organization-conformance-pack-detailed-status \
		--organization-conformance-pack-name "ManagedRules1" \
        --filters Status=UPDATE_FAILED \
        --region us-west-2
# {
#     "OrganizationConformancePackDetailedStatuses": [
#         {
#             "AccountId": "324309182124",
#             "ConformancePackName": "OrgConformsPack-ManagedRules1-zfbam2vu",
#             "Status": "UPDATE_FAILED",
#             "ErrorCode": "NoAvailableConfigurationRecorderException",
#             "ErrorMessage": "You must create a configuration recorder before you can create or update a Config rule.",
#             "LastUpdateTime": "2021-04-28T16:15:05.202000-05:00"
#         },
#         {
#             "AccountId": "440698006438",
#             "ConformancePackName": "OrgConformsPack-ManagedRules1-zfbam2vu",
#             "Status": "UPDATE_FAILED",
#             "ErrorCode": "NoAvailableConfigurationRecorderException",
#             "ErrorMessage": "You must create a configuration recorder before you can create or update a Config rule.",
#             "LastUpdateTime": "2021-04-29T14:58:58.056000-05:00"
#         },
#         {
#             "AccountId": "665356936107",
#             "ConformancePackName": "OrgConformsPack-ManagedRules1-zfbam2vu",
#             "Status": "UPDATE_FAILED",
#             "ErrorCode": "InternalError",
#             "ErrorMessage": "Cannot update a stack in DELETE_FAILED State. Please delete and re-create the conformance pack. Account Id: 665356936107, conformance pack: OrgConformsPack-ManagedRules1-zfbam2vu.",
#             "LastUpdateTime": "2021-05-16T16:11:45.200000-05:00"
#         }
#     ]
# }

aws configservice get-organization-conformance-pack-detailed-status \
		--organization-conformance-pack-name "ManagedRules1" \
        --filters Status=DELETE_FAILED \
        --region us-west-2



## delegated-administrators
aws organizations register-delegated-administrator \
	--service-principal=config-multiaccountsetup.amazonaws.com \
	--account-id=115215104958

aws organizations list-delegated-administrators


[ais-security-master-prod-4958-admin_role]
$ aws configservice describe-configuration-recorders
# {
#     "ConfigurationRecorders": [
#         {
#             "name": "AISEnableConfig-AISConfigurationRecorder-M3FCC5F85S14",
#             "roleARN": "arn:aws:iam::115215104958:role/AISEnableConfig-AISConfigRole-BQF8VF2X1ZX7",
#             "recordingGroup": {
#                 "allSupported": true,
#                 "includeGlobalResourceTypes": true,
#                 "resourceTypes": []
#             }
#         }
#     ]
# }



aws configservice list-discovered-resources \
    --resource-type AWS::EC2::Instance
# {
#     "resourceIdentifiers": [
#         {
#             "resourceType": "AWS::EC2::Instance",
#             "resourceId": "i-0134a9fcaa2e28ed4"
#         },
#         {
#             "resourceType": "AWS::EC2::Instance",
#             "resourceId": "i-020292499f5b56e07"
#         }
# }

aws configservice describe-config-rules \
    | grep ConfigRuleName

aws configservice get-resource-config-history \
    --resource-type AWS::EC2::Instance \
    --resource-id i-0e5e426970126e33e
# {
#     "configurationItems": [
#         {
#             "version": "1.3",
#             "accountId": "562798238136",
#             "configurationItemCaptureTime": 1629166242.75,
#             "configurationItemStatus": "ResourceDiscovered",
#             "configurationStateId": "1629166242750",
#             "configurationItemMD5Hash": "",
#             "arn": "arn:aws:ec2:us-west-2:562798238136:instance/i-020292499f5b56e07",
#             "resourceType": "AWS::EC2::Instance",
#             "resourceId": "i-020292499f5b56e07",
#             "awsRegion": "us-west-2",
#             "availabilityZone": "us-west-2b",
#             "resourceCreationTime": 1629166131.0,
# #             "tags": {
#                 "AIS-REQ-1": "ISDB-Service-ID=b3c4d8d7-2488-4cf5-a613-690900548495:Env=6",
#                 "Component": "Service",
#                 "Name": "Service-Green",
#                 "aws:autoscaling:groupName": "mascot-non-prod-05-Green-SVC-ASG-AutoScalingGroup-1RTR4V5U4P57N",
#                 "aws:cloudformation:logical-id": "AutoScalingGroup",
#                 "aws:cloudformation:stack-id": "arn:aws:cloudformation:us-west-2:562798238136:stack/mascot-non-prod-05-Green-SVC-ASG/acb21b00-c4bc-11e9-a93c-028572da108e",
#                 "aws:cloudformation:stack-name": "mascot-non-prod-05-Green-SVC-ASG"
#             },
#             "relatedEvents": [],
#             "relationships": [
#                 {
#                     "resourceType": "AWS::EC2::SecurityGroup",
#                     "resourceId": "sg-583f5d26",
#                     "relationshipName": "Is associated with SecurityGroup"
#                 },
#                 {
#                     "resourceType": "AWS::EC2::SecurityGroup",
#                     "resourceId": "sg-0f898354339b4f616",
#                     "relationshipName": "Is associated with SecurityGroup"
#                 },
#                 {
#                     "resourceType": "AWS::EC2::Volume",
#                     "resourceId": "vol-02032a5809b0b1800",
#                     "relationshipName": "Is attached to Volume"
#                 },
#                 {
#                     "resourceType": "AWS::EC2::NetworkInterface",
#                     "resourceId": "eni-0dc076caade38f37e",
#                     "relationshipName": "Contains NetworkInterface"
#                 },
#                 {
#                     "resourceType": "AWS::EC2::VPC",
#                     "resourceId": "vpc-bc3272da",
#                     "relationshipName": "Is contained in Vpc"
#                 },
#                 {
#                     "resourceType": "AWS::EC2::Subnet",
#                     "resourceId": "subnet-e9ef58a1",
#                     "relationshipName": "Is contained in Subnet"
#                 }
#             ],
#             "configuration": "{\"amiLaunchIndex\":0,\"imageId\":\"ami-0d8170fa9c94cd46a\",\"instanceId\":\"i-020292499f5b56e07\",\"instanceType\":\"m5.large\",\"kernelId\":null,\"keyName\":\"fruitstand-alpha\",\"launchTime\":\"2021-08-17T02:08:51.000Z\",\"monitoring\":{\"state\":\"enabled\"},\"placement\":{\"availabilityZone\":\"us-west-2b\",\"affinity\":null,\"groupName\":\"\",\"partitionNumber\":null,\"hostId\":null,\"tenancy\":\"default\",\"spreadDomain\":null,\"hostResourceGroupArn\":null},\"platform\":null,\"privateDnsName\":\"ip-10-41-192-136.us-west-2.compute.internal\",\"privateIpAddress\":\"10.41.192.136\",\"productCodes\":[],\"publicDnsName\":\"\",\"publicIpAddress\":null,\"ramdiskId\":null,\"state\":{\"code\":16,\"name\":\"running\"},\"stateTransitionReason\":\"\",\"subnetId\":\"subnet-e9ef58a1\",\"vpcId\":\"vpc-bc3272da\",\"architecture\":\"x86_64\",\"blockDeviceMappings\":[{\"deviceName\":\"/dev/xvda\",\"ebs\":{\"attachTime\":\"2021-08-17T02:08:52.000Z\",\"deleteOnTermination\":true,\"status\":\"attached\",\"volumeId\":\"vol-02032a5809b0b1800\"}}],\"clientToken\":\"6d55ed47-7944-78d8-a9a6-9148bc7aefe1\",\"ebsOptimized\":false,\"enaSupport\":true,\"hypervisor\":\"xen\",\"iamInstanceProfile\":{\"arn\":\"arn:aws:iam::562798238136:instance-profile/aws-elasticbeanstalk-mascot-service-ec2-role\",\"id\":\"AIPAITNEMLKH42ZQA65SO\"},\"instanceLifecycle\":null,\"elasticGpuAssociations\":[],\"elasticInferenceAcceleratorAssociations\":[],\"networkInterfaces\":[{\"association\":null,\"attachment\":{\"attachTime\":\"2021-08-17T02:08:51.000Z\",\"attachmentId\":\"eni-attach-07dff0bd3fc87605e\",\"deleteOnTermination\":true,\"deviceIndex\":0,\"status\":\"attached\",\"networkCardIndex\":0},\"description\":\"\",\"groups\":[{\"groupName\":\"mascot-non-prod-01-SGs-ServiceAsgSecurityGroup-8D3BLB05DHHG\",\"groupId\":\"sg-0f898354339b4f616\"},{\"groupName\":\"MASCOT-VPC-AISSharedServicesSecurityGroup-XLBUEO3ZY9PB\",\"groupId\":\"sg-583f5d26\"}],\"ipv6Addresses\":[],\"macAddress\":\"06:73:d0:85:4a:f1\",\"networkInterfaceId\":\"eni-0dc076caade38f37e\",\"ownerId\":\"562798238136\",\"privateDnsName\":\"ip-10-41-192-136.us-west-2.compute.internal\",\"privateIpAddress\":\"10.41.192.136\",\"privateIpAddresses\":[{\"association\":null,\"primary\":true,\"privateDnsName\":\"ip-10-41-192-136.us-west-2.compute.internal\",\"privateIpAddress\":\"10.41.192.136\"}],\"sourceDestCheck\":true,\"status\":\"in-use\",\"subnetId\":\"subnet-e9ef58a1\",\"vpcId\":\"vpc-bc3272da\",\"interfaceType\":\"interface\"}],\"outpostArn\":null,\"rootDeviceName\":\"/dev/xvda\",\"rootDeviceType\":\"ebs\",\"securityGroups\":[{\"groupName\":\"mascot-non-prod-01-SGs-ServiceAsgSecurityGroup-8D3BLB05DHHG\",\"groupId\":\"sg-0f898354339b4f616\"},{\"groupName\":\"MASCOT-VPC-AISSharedServicesSecurityGroup-XLBUEO3ZY9PB\",\"groupId\":\"sg-583f5d26\"}],\"sourceDestCheck\":true,\"spotInstanceRequestId\":null,\"sriovNetSupport\":null,\"stateReason\":null,\"tags\":[{\"key\":\"Name\",\"value\":\"Service-Green\"},{\"key\":\"aws:autoscaling:groupName\",\"value\":\"mascot-non-prod-05-Green-SVC-ASG-AutoScalingGroup-1RTR4V5U4P57N\"},{\"key\":\"aws:cloudformation:logical-id\",\"value\":\"AutoScalingGroup\"},{\"key\":\"Component\",\"value\":\"Service\"},{\"key\":\"aws:cloudformation:stack-id\",\"value\":\"arn:aws:cloudformation:us-west-2:562798238136:stack/mascot-non-prod-05-Green-SVC-ASG/acb21b00-c4bc-11e9-a93c-028572da108e\"},{\"key\":\"aws:cloudformation:stack-name\",\"value\":\"mascot-non-prod-05-Green-SVC-ASG\"},{\"key\":\"AIS-REQ-1\",\"value\":\"ISDB-Service-ID\\u003db3c4d8d7-2488-4cf5-a613-690900548495:Env\\u003d6\"}],\"virtualizationType\":\"hvm\",\"cpuOptions\":{\"coreCount\":1,\"threadsPerCore\":2},\"capacityReservationId\":null,\"capacityReservationSpecification\":{\"capacityReservationPreference\":\"open\",\"capacityReservationTarget\":null},\"hibernationOptions\":{\"configured\":false},\"licenses\":[],\"metadataOptions\":{\"state\":\"applied\",\"httpTokens\":\"optional\",\"httpPutResponseHopLimit\":1,\"httpEndpoint\":\"enabled\"},\"enclaveOptions\":{\"enabled\":false},\"bootMode\":null}",
#             "supplementaryConfiguration": {}
#         }
#     ]
# }


```



## elasticache

```bash
aws elasticache describe-cache-clusters | grep CacheClusterId
# {"CacheClusters": [
#         {"CacheClusterId": "test-grace-ssmdoc-001",},
#         {"CacheClusterId": "test-grace-ssmdoc-002",},
#         {"CacheClusterId": "test-grace-ssmdoc-003",}
#     ]}

aws elasticache describe-cache-clusters \
	--query 'CacheClusters[].ReplicationGroupId'

aws elasticache describe-replication-groups | grep ReplicationGroupId
# {"ReplicationGroups": [
#         {"ReplicationGroupId": "test-grace-ssmdoc",}
#     ]}

aws elasticache describe-replication-groups \
	--replication-group-id test-ssm-doc-grace \
	--query 'ReplicationGroups[*].[AtRestEncryptionEnabled]'


## Backing up a Redis (Cluster Mode Disabled) cluster that has no replica nodes
aws elasticache create-snapshot \
    --cache-cluster-id myNonClusteredRedis \
    --snapshot-name bkup-20150515
# Backing up a Redis (Cluster Mode Disabled) cluster with replica nodes
aws elasticache create-snapshot \
    --cache-cluster-id myNonClusteredRedis-001 \
    --snapshot-name bkup-20150515


## Backing up a cluster for Redis (Cluster Mode Enabled)
aws elasticache create-snapshot \
    --replication-group-id test-ssm-doc-grace \
    --snapshot-name backup-123
{
    "Snapshot": {
        "SnapshotName": "backup-123",
        "ReplicationGroupId": "test-ssm-doc-grace",
        "ReplicationGroupDescription": "test for ssm doc",
        "SnapshotStatus": "creating",
        "SnapshotSource": "manual",
        "CacheNodeType": "cache.r6g.large",
        "Engine": "redis",
        "EngineVersion": "6.0.5",
        "PreferredMaintenanceWindow": "wed:09:30-wed:10:30",
        "Port": 6379,
        "CacheParameterGroupName": "default.redis6.x.cluster.on",
        "CacheSubnetGroupName": "test-grace-ssmdoc-sg",
        "VpcId": "vpc-0d511e498f63cadb7",
        "AutoMinorVersionUpgrade": true,
        "SnapshotRetentionLimit": 1,
        "SnapshotWindow": "13:00-14:00",
        "NumNodeGroups": 3,
        "AutomaticFailover": "enabled",
        "NodeSnapshots": [
            {
                "NodeGroupId": "0001",
                "CacheSize": ""
            },
            {
                "NodeGroupId": "0002",
                "CacheSize": ""
            },
            {
                "NodeGroupId": "0003",
                "CacheSize": ""
            }
        ],
        "ARN": "arn:aws:elasticache:us-west-2:665356936107:snapshot:backup-123"
    }
}


aws elasticache create-replication-group \
	--replication-group-id test-ssm-doc-grace-encrypted \
	--replication-group-description "test encrypted" \
	--snapshot-name backup-123 \
	--engine "redis" \
	--cache-node-type "cache.r6g.large" \
	--cache-subnet-group-name test-grace-ssmdoc-sg \
	--at-rest-encryption-enabled
{
    "ReplicationGroup": {
        "ReplicationGroupId": "test-ssm-doc-grace-encrypted",
        "Description": "test encrypted",
        "GlobalReplicationGroupInfo": {},
        "Status": "creating",
        "PendingModifiedValues": {},
        "MemberClusters": [
            "test-ssm-doc-grace-encrypted-0001-001",
            "test-ssm-doc-grace-encrypted-0001-002",
            "test-ssm-doc-grace-encrypted-0001-003",
            "test-ssm-doc-grace-encrypted-0002-001",
            "test-ssm-doc-grace-encrypted-0002-002",
            "test-ssm-doc-grace-encrypted-0002-003",
            "test-ssm-doc-grace-encrypted-0003-001",
            "test-ssm-doc-grace-encrypted-0003-002",
            "test-ssm-doc-grace-encrypted-0003-003"
        ],
        "AutomaticFailover": "enabled",
        "MultiAZ": "enabled",
        "SnapshotRetentionLimit": 0,
        "SnapshotWindow": "07:00-08:00",
        "ClusterEnabled": true,
        "CacheNodeType": "cache.r6g.large",
        "TransitEncryptionEnabled": false,
        "AtRestEncryptionEnabled": true,
        "ARN": "arn:aws:elasticache:us-west-2:665356936107:replicationgroup:test-ssm-doc-grace-encrypted"
    }
}
```


## sqs


```bash
aws sqs get-queue-attributes \
    --queue-url "https://us-west-2.queue.amazonaws.com/914677001772/account-decom-expired-notifications-queue"



define the required set-queue-attributes command attributes and save them into a JSON file named enable-sqs-sse.json. Based on the KMS CMK key type used (AWS-managed or custom CMK), choose to define one of the following options:

To use the AWS-managed CMK key:
{
  "KmsMasterKeyId": "alias/aws/sqs",
  "KmsDataKeyReusePeriodSeconds": "300"
}


To use your custom KMS CMK key.
{
  "KmsMasterKeyId": "<kms_cmk_custom_key_arn>",
  "KmsDataKeyReusePeriodSeconds": "300"
}


aws sqs set-queue-attributes
	--region us-west-2
	--queue-url https://us-west-2.queue.amazonaws.com/123456789012/WebWorkerSQSQueue
	--attributes file://enable-sqs-sse.json
```


---


## audit manager



```bash

aws auditmanager list-assessments

aws auditmanager create-assessment-report \
    --name Report0526\
    --assessment-id 95ec4447-4ffc-4968-8835-5056451d00ef


```


---

## access analyzer

```bash

aws accessanalyzer create-access-preview \
    --analyzer-arn 'arn:aws:access-analyzer:us-west-2:665356936107:analyzer/AISAccountAnalyzer' \
    | jq -r


aws accessanalyzer list-access-previews \
    --analyzer-arn 'arn:aws:access-analyzer:us-west-2:665356936107:analyzer/AISAccountAnalyzer' \
    | jq -r



aws accessanalyzer list-findings \
    --analyzer-arn 'arn:aws:access-analyzer:us-west-2:665356936107:analyzer/AISAccountAnalyzer' \
    | jq -r '.findings[].id'

aws accessanalyzer list-findings \
    --analyzer-arn 'arn:aws:access-analyzer:us-west-2:665356936107:analyzer/AISAccountAnalyzer' \
    | jq -r '.findings[].status'



aws accessanalyzer get-finding \
    --analyzer-arn 'arn:aws:access-analyzer:us-west-2:665356936107:analyzer/AISAccountAnalyzer' \
    --id '8580670b-22ec-41c8-91cb-c01bc6954195' \
    | jq -r



aws accessanalyzer get-finding \
    --analyzer-arn 'arn:aws:access-analyzer:us-west-2:665356936107:analyzer/AISAccountAnalyzer' \
    --id '9149910b-8804-456a-95c5-5215cf2f2097' \
    | jq -r







for region in us-west-2 us-east-1 ap-southeast-1 eu-west-1 ap-northeast-1; do \
    aws accessanalyzer list-findings \
        --analyzer-arn $(aws accessanalyzer list-analyzers \
                            --output text \
                            --query 'analyzers[].[arn]' \
                            --region ${region}) \
        > /tmp/findings-${region}.json; \
    done


$ wc -l /tmp/findings-*
    0 /tmp/findings-ap-northeast-1.json
    0 /tmp/findings-ap-southeast-1.json
    0 /tmp/findings-eu-west-1.json
    0 /tmp/findings-us-east-1.json
 1234 /tmp/findings-us-west-2.json

jq -r '.findings[].principal.AWS' < findings-us-west-2.json | sort -u

aws accessanalyzer \
    --policy-document "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Allow\",\"Action\":\"*\"}]" \
    --policy-type SERVICE_CONTROL_POLICY


aws accessanalyzer \
    --policy-document "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Deny\",\"Action\":[\"ssm:DeleteParameter\",\"ssm:DeleteParameters\",\"ssm:PutParameter\"],\"Resource\":[\"arn:aws:ssm:*:*:parameter/GNCS/*\"],\"Condition\":{\"ArnNotLike\":{\"aws:PrincipalArn\":[\"arn:aws:iam::*:role/ais-denali-ops-role\",\"arn:aws:iam::*:role/admin_role\",\"arn:aws:iam::*:role/account-setup*\",\"arn:aws:iam::*:role/ais/*\",\"arn:aws:iam::*:role/AWSCloudFormationStackSetExecutionRole\"]}}},{\"Effect\":\"Deny\",\"Action\":[\"cloudtrail:StopLogging\",\"cloudtrail:DeleteTrail\",\"cloudtrail:RemoveTags\",\"cloudtrail:UpdateTrail\",\"cloudtrail:PutEventSelectors\",\"cloudtrail:AddTags\"],\"Resource\":[\"arn:aws:cloudtrail:*:*:trail/EnableCloudTrailAIS*\"],\"Condition\":{\"ArnNotLike\":{\"aws:PrincipalArn\":[\"arn:aws:iam::*:role/admin_role\",\"arn:aws:iam::*:role/account-setup*\",\"arn:aws:iam::*:role/ais/*\",\"arn:aws:iam::*:role/AWSCloudFormationStackSetExecutionRole\"]}}},{\"Effect\":\"Deny\",\"Action\":[\"config:DeleteConfigurationRecorder\",\"config:PutConfigurationRecorder\",\"config:StartConfigurationRecorder\",\"config:StopConfigurationRecorder\"],\"Resource\":[\"*\"],\"Condition\":{\"ArnNotLike\":{\"aws:PrincipalArn\":[\"arn:aws:iam::*:role/admin_role\",\"arn:aws:iam::*:role/account-setup*\",\"arn:aws:iam::*:role/ais/*\",\"arn:aws:iam::*:role/AWSCloudFormationStackSetExecutionRole\"]}}},{\"Effect\":\"Deny\",\"Action\":[\"logs:deleteLogGroup\",\"logs:deleteLogStream\",\"logs:deleteSubscriptionFilter\",\"codebuild:DeleteProject\",\"codebuild:UpdateProject\",\"codebuild:PutResourcePolicy\",\"iam:DetachRolePolicy\",\"ssm:DeleteParameter\",\"ssm:DeleteParameters\",\"ssm:PutParameter\"],\"Resource\":[\"arn:aws:logs:*:*:log-group:AISCloudwatchLogs:log-stream:*\",\"arn:aws:codebuild:*:*:project/AIS*\",\"arn:aws:iam::*:policy/AISSystemLogsPolicy\",\"arn:aws:iam::*:policy/AmazonSSMManagedInstanceCore\",\"arn:aws:ssm:*:*:parameter/AIS/*\",\"arn:aws:ssm:*:*:parameter/CodeBuild/*\"],\"Condition\":{\"ArnNotLike\":{\"aws:PrincipalArn\":[\"arn:aws:iam::*:role/admin_role\",\"arn:aws:iam::*:role/account-setup*\",\"arn:aws:iam::*:role/AWSCloudFormationStackSetExecutionRole\",\"arn:aws:iam::051553761794:role/AisImageBuilderAutomationServiceRole\",\"arn:aws:iam::*:role/ais/*\"]}}},{\"Effect\":\"Deny\",\"Action\":[\"lambda:Delete*\",\"lambda:Update*\"],\"Resource\":[\"arn:aws:lambda:*:*:function:ais*\",\"arn:aws:lambda:*:*:function:import_keypair\",\"arn:aws:lambda:*:*:function:iam_password_policy\",\"arn:aws:lambda:*:*:function:VPC-Endpoint-Policy-Updater-vpc-endpoint-policy-updater\"],\"Condition\":{\"ArnNotLike\":{\"aws:PrincipalArn\":[\"arn:aws:iam::*:role/admin_role\",\"arn:aws:iam::*:role/ais/*\"]}}},{\"Effect\":\"Deny\",\"Action\":[\"rds:CreateDBInstance\"],\"Resource\":[\"*\"],\"Condition\":{\"ForAllValues:StringNotEquals\":{\"rds:DatabaseEngine\":[\"aurora\",\"aurora-mysql\",\"aurora-postgresql\",\"neptune\"]},\"Bool\":{\"rds:StorageEncrypted\":\"false\"}}},{\"Effect\":\"Deny\",\"Action\":[\"rds:CreateDBCluster\"],\"Resource\":[\"*\"],\"Condition\":{\"Bool\":{\"rds:StorageEncrypted\":\"false\"}}},{\"Effect\":\"Deny\",\"Action\":\"apigateway:*\",\"Resource\":[\"arn:aws:apigateway:*::/apis/*\",\"arn:aws:apigateway:*::/apis\"]},{\"Effect\":\"Deny\",\"Action\":[\"ec2:DisableEbsEncryptionByDefault\"],\"Resource\":[\"*\"]},{\"Effect\":\"Deny\",\"Action\":[\"sagemaker:CreatePresignedNotebookInstanceUrl\",\"sagemaker:DescribeNotebookInstance\"],\"Resource\":\"*\",\"Condition\":{\"NotIpAddress\":{\"aws:SourceIp\":[\"17.0.0.0/8\"]}}},{\"Effect\":\"Deny\",\"Action\":[\"sso:*\",\"sso-directory:*\",\"iq:*\",\"iq-permission:*\",\"mechanicalturk:*\",\"mq:*\"],\"Resource\":\"*\"},{\"Action\":[\"ec2:DeleteSecurityGroup\"],\"Effect\":\"Deny\",\"Resource\":\"*\",\"Condition\":{\"StringLike\":{\"ec2:ResourceTag/ManagedBy\":\"AIS\"},\"ArnNotLike\":{\"aws:PrincipalArn\":[\"arn:aws:iam::*:role/admin_role\",\"arn:aws:iam::*:role/ais/*\"]}}}]}" \
    --policy-type SERVICE_CONTROL_POLICY

```


---



## appmesh

```bash


aws appmesh create-virtual-gateway \
    --mesh-name test-grace \
    --virtual-gateway-name test-grace
    --spec

```







## accessanalyzer


```bash

aws accessanalyzer validate-policy \
    --policy-document '{ "Version": "2012-10-17", "Statement": [ {"Effect": "Deny","Action": "*", "Resource": "*"} ] }' \
    --policy-type IDENTITY_POLICY/RESOURCE_POLICY/SERVICE_CONTROL_POLICY


aws accessanalyzer validate-policy \
    --policy-document IAMLockdown \
    --policy-type SERVICE_CONTROL_POLICY \
    --profile ais-customer-test

aws accessanalyzer validate-policy \
    --policy-document '{ "Version": "2012-10-17", "Statement": [ {"Effect": "Deny","Action": "*", "Resource": "*"} ] }' \
    --policy-type SERVICE_CONTROL_POLICY \
    --profile ais-customer-test

GOOD='"Version": "2012-10-17", "Statement": [ {"Effect": "Deny","Action": "*", "Resource": "*"} ] }'
echo  $GOOD


TEXT=$(cat test.json | jq -r )
echo $TEXT


VAL=$(cat test.json)

SPACE="'"

JSONTEXT=$(echo $SPACE $TEXT $SPACE)
echo $JSONTEXT

JSONTEXT=$(echo $SPACE $GOOD $SPACE)
echo $JSONTEXT

JSONTEXT=$(echo $SPACE $VAL $SPACE)
echo $JSONTEXT



TEXT=$(cat OrgDenylistPolicy.json | jq -r )
echo $TEXT

aws accessanalyzer validate-policy \
    --policy-document $TEXT \
    --policy-type SERVICE_CONTROL_POLICY \
    --profile ais-customer-test

TEXT=$(echo $TEXT | jq -r)
echo $TEXT

TEXT=$(python -c 'import json; data = open("./OrgDenylistPolicy.json", encoding="utf-8"); result = json.dumps(json.load(data)); print("'"+result+"'")')



TEXT=$(python -c "import json; print('\''+'result'+'\'')")
echo $TEXT


TEXT=$(python -c "  import json; \
                    data = open('./OrgDenylistPolicy.json', encoding='utf-8'); \
                    result = json.dumps(json.load(data)); \
                    print('\''+result+'\'')")
echo $TEXT
# '{ "Version": "2012-10-17", "Statement": [{"Effect": "Deny", "Action": "*", "Resource": "*"}]}'

aws accessanalyzer validate-policy \
    --policy-document $TEXT \
    --policy-type SERVICE_CONTROL_POLICY \
    --profile ais-customer-test
# "JSON_SYNTAX_ERROR"


aws accessanalyzer validate-policy \
    --policy-document '{ "Version": "2012-10-17", "Statement": [{"Effect": "Deny", "Action": "*", "Resource": "*"}]}' \
    --policy-type SERVICE_CONTROL_POLICY \
    --profile ais-customer-test




SPACE="'"
JSONTEXT=$(echo $SPACE $TEXT $SPACE)
echo $JSONTEXT


jq -c < OrgDenylistPolicy.json | wc -c
jq -c < $TEXT | wc -c

my_val="$(json=$(<OrgDenylistPolicy.json))"
echo $my_val


cat file.json | python -c "import sys, json, jsonpath; print '\n'.join(jsonpath.jsonpath(json.load(sys.stdin), 'store.book[?(@.price < 10)].title'))"

cat OrgDenylistPolicy.json | python -c "import sys, json; a = sys.stdin; y=json.dumps(a); print(y);print(type(y))"

```







---


## OU

```bash
aws organizations list-organizational-units-for-parent \
    --parent-id r-tbus
# {
#     "OrganizationalUnits": [
#         {
#             "Id": "ouxxzg",
#             "Arn": "arn:aws:organizations::324309182124:ou/o-dd0/ddzg",
#             "Name": "Deletion"
#         }
# }

aws organizations list-policies \
    --filter 'SERVICE_CONTROL_POLICY'
# {
#     "Policies": [
#         {
#             "Id": "p-FullAWSAccess",
#             "Arn": "arn:aws:organizations::aws:policy/service_control_policy/p-FullAWSAccess",
#             "Name": "FullAWSAccess",
#             "Description": "Allows access to every operation",
#             "Type": "SERVICE_CONTROL_POLICY",
#             "AwsManaged": true
#         },
#         {
#             "Id": "p-pj68tc7y",
#             "Arn": "arn:aws:organizations::324309182124:policy/o-fegcgd9jw0/service_control_policy/p-pj68tc7y",
#             "Name": "IAMLockdown-Prod",
#             "Description": "LockDown IAM permissions on AIS roles",
#             "Type": "SERVICE_CONTROL_POLICY",
#             "AwsManaged": false
#         }
# }


aws organizations describe-policy \
    --policy-id p-FullAWSAccess




```




## RAM


```bash
aws ram get-resource-shares --resource-owner SELF
{
    "resourceShares": [
        {
            "resourceShareArn": "arn:aws:ram:us-west-2:665356936107:resource-share/15251ca6-ada2-4c00-9249-96c805b9a6bf",
            "name": "test-grace",
            "owningAccountId": "665356936107",
            "allowExternalPrincipals": true,
            "status": "ACTIVE",
            "creationTime": "2021-06-20T22:07:10.322000-05:00",
            "lastUpdatedTime": "2021-06-20T22:07:10.322000-05:00",
            "featureSet": "STANDARD"
        }
    ]
}

aws ram list-resources --resource-owner SELF
{
    "resources": [
        {
            "arn": "arn:aws:license-manager:us-west-2:665356936107:license-configuration:lic-38bd0c0e9e15cb0901501b6edc755f4a",
            "type": "license-manager:LicenseConfiguration",
            "resourceShareArn": "arn:aws:ram:us-west-2:665356936107:resource-share/15251ca6-ada2-4c00-9249-96c805b9a6bf",
            "creationTime": "2021-06-20T22:07:10.322000-05:00",
            "lastUpdatedTime": "2021-06-20T22:07:11.475000-05:00"
        }
    ]
}


```


## License manager


```bash


aws license-manager list-license-configurations


aws license-manager get-access-token \
    --token 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTIzNDU2Nzg5LCJuYW1lIjoiSm9zZXBoIn0.OpOSSw7e485LOP5PrzScxHb7SR6sAOMRckfFwi4rp7o'


aws license-manager create-license \
    --license-name 'test' \
    --product-name 'test-grace' \
    --product-sku '12345' \
    --issuer 'Name=grace' \
    --home-region 'google.com' \
    --validity 'Begin=1994-11-05T13:15:30Z' \
    --entitlements 'Name=string,Value=string,MaxCount=3,Overage=true,Unit="None",AllowCheckIn=true' \
    --beneficiary 'test-grace' \
    --consumption-configuration 'RenewType="None",ProvisionalConfiguration={MaxTimeToLiveInMinutes=45},BorrowConfiguration={AllowEarlyCheckIn=true,MaxTimeToLiveInMinutes=45}' \
    --client-token '5555ygd5'

aws license-manager list-licenses
{
    "Licenses": []
}

aws license-manager create-token \
    --license-arn xxx


```



## code guru

```bash
aws codeguru-reviewer associate-repository \
    --repository 'Bitbucket={
        Owner=sample-owner,
        Name=mySampleRepo,
        ConnectionArn=arn:aws:codestar-connections:us-west-2:123456789012:connection/a1b2c3d4-5678-90ab-cdef-EXAMPLE11111 }'



```



---



## dynamodb


- https://segmentfault.com/a/1190000008232386
- https://www.coder.work/article/358352
- https://stackoverflow.com/questions/34492501/difference-between-and-or-and
- https://boto3.amazonaws.com/v1/documentation/api/latest/reference/customizations/dynamodb.html
- https://boto3.amazonaws.com/v1/documentation/api/latest/reference/customizations/dynamodb.html#ref-dynamodb-conditions
- https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Expressions.ProjectionExpressions.html
- https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Expressions.ExpressionAttributeNames.html
- https://www.fernandomc.com/posts/ten-examples-of-getting-data-from-dynamodb-with-python-and-boto3/
- https://stackoverflow.com/questions/37589254/not-able-to-get-item-from-aws-dynamodb-using-python
- https://stackoverflow.com/questions/64779010/is-it-possible-to-filter-a-dynamodb-query-result-in-python
- https://stackoverflow.com/questions/44704443/dynamodb-scan-using-filterexpression
- https://stackoverflow.com/questions/47855956/aws-dynamodb-python-filtering-or-querying-by-the-contents-of-a-list-in-dynamod
- https://stackoverflow.com/questions/65695788/how-to-query-dynamodb-filtering-by-value-in-a-list/65695949
- https://www.programcreek.com/python/example/103724/boto3.dynamodb.conditions.Attr
- https://highlandsolutions.com/blog/hands-on-examples-for-working-with-dynamodb-boto3-and-python
- https://learn-to-code.workshop.aws/persisting_data/dynamodb/step-4.html
- https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/GettingStarted.Python.04.html




```bash
aws dynamodb list-tables



aws dynamodb describe-table \
    --table-name Movies

```
